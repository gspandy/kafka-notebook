# 1. kafka 文件存储机制

![](../../assets/kafka文件存储机制.png)

## 1.1 Partition

### 定义

同一个topic下有多个不同的partition，每个partition为一个目录。

### 命名规则

Partition命名规则: topic名称 + 序号，序号从0开始。

如，mytopic 这个 topic有3个分区，则其对应的文件的文件夹为 mytopic-0、mytopic-1、mytopic-2


### 配置

Partition文件的目录在 server.properties 中配置:

`注意`: 一般默认为 logs，但是最好将其和logs文件分开，做到数据和日志分离。


```
# server.properties文件中
log.dirs=kafka安装目录/data

# 多个地址的话用逗号分割
log.dirs=kafka安装目录/kafka-logs-1，kafka安装目录/kafka-logs-2
```

## 1.2 Segment File

由于生产者生产的消息会不断追加到 log 文件末尾，为防止 log文件过大导致数据定位效率低下，kafka采取了 **分片** 和 **索引**机制，将每个 partition 分为多个 segment。


### 定义

Segment File在 topic的Partition下，每个 Segment File由一对 .index索引文件 和 .log数据文件组成，被称为一个段。


`注意`: 每个段消息数量不一定相等，这种特性能够使得老的segment可以被快速清除。

> .timeindex文件。（0.8版本之前的kafka没有timeindex文件）, 是kafka的具体时间日志

### 命名规则

partion全局的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset值。

数值最大为64位long大小，19位数字字符长度，没有数字用0填充。

**查看 mytopic0分区下的文件**

```shell script
[root@www mytopic-0]# ll -lh
total 8.0K
-rw-r--r-- 1 root root  10M Nov  5 18:09 00000000000000000000.index
-rw-r--r-- 1 root root 2.6K Nov  8 22:22 00000000000000000000.log
-rw-r--r-- 1 root root  10M Nov  5 18:09 00000000000000000000.timeindex
-rw-r--r-- 1 root root    8 Nov  5 18:09 leader-epoch-checkpoint
```

### 配置

Partition文件的目录在 server.properties 中配置:

* 文件大小

Segment File默认大小为 1G，每满500兆就会创建新的segment段。

设置参数如下:

```
# server.properties文件中

log.segment.bytes =1024*1024*1024
```

* 保存最长时间

Segment File默认保存最长时间为 7天，超过7天会被清理 log文件和index文件:

设置参数如下:

```
# server.properties文件中

log.roll.hours =24*7
```